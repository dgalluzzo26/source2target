<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mapper V4 - Target-First AI Architecture</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #6366f1;
            --accent: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            text-align: center;
            padding: 3rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 3rem;
        }
        
        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        .version-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        
        .section {
            margin-bottom: 4rem;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
            display: inline-block;
        }
        
        /* Flow Diagram */
        .flow-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        
        .flow-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }
        
        .flow-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-right: 1.5rem;
        }
        
        .step-content h4 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .step-content p {
            color: var(--text-secondary);
        }
        
        .step-visual {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        
        /* Stage boxes */
        .stage-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .stage-box h5 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        /* Decision boxes */
        .decision-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .decision-option {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 1rem;
            border: 2px solid var(--border);
        }
        
        .decision-option.yes { border-color: var(--primary); }
        .decision-option.no { border-color: #ef4444; }
        
        .decision-option h6 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .decision-option ul {
            list-style: none;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Arrow Animation */
        .arrow-down {
            text-align: center;
            font-size: 2rem;
            color: var(--primary);
            margin: 1rem 0;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(10px); }
        }
        
        /* Highlight box */
        .highlight-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        /* Data Structure Tables */
        .table-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        
        .table-container h4 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .badge {
            background: var(--accent);
            color: var(--bg-dark);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .badge.vector { background: var(--secondary); color: white; }
        .badge.new { background: var(--primary); color: white; }
        .badge.key { background: #ef4444; color: white; }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-dark);
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        td {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        td code {
            background: var(--bg-dark);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--accent);
        }
        
        /* Benefits Grid */
        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .benefit {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .benefit-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .benefit h4 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .benefit p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Comparison */
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .comparison-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .comparison-box.before { border-top: 4px solid #ef4444; }
        .comparison-box.after { border-top: 4px solid var(--primary); }
        
        .comparison-box h4 { margin-bottom: 1rem; }
        
        .comparison-box pre {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        
        /* LLM Prompt Box */
        .llm-prompt {
            background: #1a1a2e;
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .llm-prompt h5 {
            color: var(--secondary);
            margin-bottom: 1rem;
        }
        
        .llm-prompt pre {
            font-size: 0.8rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            border-top: 1px solid var(--border);
            margin-top: 3rem;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .comparison, .decision-box {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¯ Smart Mapper V4 Architecture</h1>
            <p>Target-First AI Mapping with Pattern Reuse</p>
            <div class="version-badge">V4 - Target-First Workflow</div>
        </header>
        
        <!-- Executive Summary -->
        <section class="section">
            <h2 class="section-title">Executive Summary</h2>
            <p style="font-size: 1.1rem; max-width: 900px;">
                Smart Mapper V4 uses a <strong>Target-First approach</strong>: instead of mapping source â†’ target,
                we start with what target columns need to be populated, find historical patterns for each,
                then match the user's source columns to those patterns using <strong>Vector Search</strong>
                and rewrite the SQL using an <strong>LLM</strong>.
            </p>
            
            <div class="highlight-box">
                <h4 style="margin-bottom: 0.5rem;">ğŸ¯ Key Innovation: Pattern-Based SQL Rewriting</h4>
                <p style="color: var(--text-secondary);">
                    Historical approved mappings serve as <strong>patterns</strong>. When a new user needs to map 
                    their sources, the AI finds a matching pattern and rewrites the SQL by replacing the 
                    pattern's source columns with the user's semantically-similar columns.
                </p>
            </div>
        </section>
        
        <!-- The V4 Workflow -->
        <section class="section">
            <h2 class="section-title">The V4 Target-First Workflow</h2>
            
            <div class="comparison" style="margin-bottom: 2rem;">
                <div class="comparison-box before">
                    <h4>âŒ V3 Source-First (Old)</h4>
                    <pre>1. User selects SOURCE column
2. AI finds matching TARGET
3. AI suggests transformation
4. User approves

Problem: Many targets never get mapped
if user doesn't find the right source</pre>
                </div>
                <div class="comparison-box after">
                    <h4>âœ… V4 Target-First (New)</h4>
                    <pre>1. Show all TARGET columns needed
2. For each target, find PATTERN
3. Match user's sources to pattern
4. Rewrite SQL with user's sources
5. User reviews & approves

Benefit: Complete coverage of targets</pre>
                </div>
            </div>
        </section>
        
        <!-- Complete Discovery Flow -->
        <section class="section">
            <h2 class="section-title">AI Discovery Flow (Step-by-Step)</h2>
            
            <div class="flow-container">
                
                <!-- Step 1 -->
                <div class="stage-box">
                    <h5>â•â•â• STAGE 1: PROJECT SETUP â•â•â•</h5>
                    <p style="color: var(--text-secondary);">User creates project and uploads source fields</p>
                </div>
                
                <div class="flow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>User Creates Project & Uploads Sources</h4>
                        <p>User creates a mapping project and uploads their source system's columns via CSV</p>
                        <div class="step-visual">
<strong>Project:</strong> "ACME Member Migration"
<strong>Domains:</strong> Member, Claims

<strong>Uploaded Source Fields (unmapped_fields table):</strong>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ src_table            â”‚ src_column       â”‚ src_comments                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ACME_RECIPIENT       â”‚ RECIP_KEY        â”‚ Primary identifier for the recipient       â”‚
â”‚ ACME_RECIPIENT       â”‚ STREET_ADDR_1    â”‚ Primary street address line                â”‚
â”‚ ACME_RECIPIENT       â”‚ CITY             â”‚ City name from recipient address           â”‚
â”‚ ACME_ADDR_HISTORY    â”‚ ADDR_LINE_1      â”‚ First line of historical address           â”‚
â”‚ ...                  â”‚ ...              â”‚ ...                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <!-- Step 2 -->
                <div class="flow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Initialize Target Tables</h4>
                        <p>System loads target columns from <code>semantic_fields</code> for the project's domains</p>
                        <div class="step-visual">
<strong>Query semantic_fields for domain = 'Member':</strong>

SELECT * FROM semantic_fields 
WHERE UPPER(domain) = 'MEMBER'

<strong>Result â†’ target_table_status:</strong>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tgt_table      â”‚ tgt_column   â”‚ tgt_comments                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MBR_CNTCT      â”‚ MBR_SK       â”‚ Unique identifier for member                   â”‚
â”‚ MBR_CNTCT      â”‚ ADDR_1_TXT   â”‚ First address line of mailing address          â”‚
â”‚ MBR_CNTCT      â”‚ CITY_NM      â”‚ City of mailing address                        â”‚
â”‚ MBR_CNTCT      â”‚ ST_CD        â”‚ State of mailing address                       â”‚
â”‚ ...            â”‚ ...          â”‚ ...                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <!-- Stage 2 -->
                <div class="stage-box">
                    <h5>â•â•â• STAGE 2: AI DISCOVERY (Per Table) â•â•â•</h5>
                    <p style="color: var(--text-secondary);">User clicks "Discover" on a target table â†’ AI processes each column</p>
                </div>
                
                <!-- Step 3 -->
                <div class="flow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>For Each Target Column: Find Pattern</h4>
                        <p>Look up approved historical mappings from <code>mapped_fields</code> where <code>project_id IS NULL</code></p>
                        <div class="step-visual">
<strong>Query for ADDR_1_TXT pattern:</strong>

SELECT source_expression, source_descriptions, join_metadata
FROM mapped_fields 
WHERE tgt_column_physical_name = 'ADDR_1_TXT'
  AND tgt_table_physical_name = 'MBR_CNTCT'
  AND is_approved_pattern = TRUE
  AND project_id IS NULL  -- Global patterns only

<strong>Result (Pattern Found):</strong>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ source_expression:                                                                      â”‚
â”‚   SELECT DISTINCT TRIM(INITCAP(b.ADR_LINE_1)) as ADDR_1_TXT                            â”‚
â”‚   FROM oz_dev.bronze_dmes_de.t_re_base b                                               â”‚
â”‚   JOIN oz_dev.silver_dmes_de.mbr_fndtn mf ON b.SAK_RECIP = mf.SRC_KEY_ID              â”‚
â”‚   ...UNION DISTINCT...                                                                  â”‚
â”‚                                                                                         â”‚
â”‚ source_descriptions:                                                                    â”‚
â”‚   ADR_LINE_1: First line of mailing address | SAK_RECIP: Recipient ID from bronze     â”‚
â”‚                                                                                         â”‚
â”‚ join_metadata: { silverTables: [...], userColumnsToMap: [...] }                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </div>
                        
                        <div class="decision-box">
                            <div class="decision-option yes">
                                <h6>âœ… Pattern Found</h6>
                                <ul>
                                    <li>â†’ Continue to Step 4 (Source Matching)</li>
                                    <li>â†’ Status: Processing</li>
                                </ul>
                            </div>
                            <div class="decision-option no">
                                <h6>âŒ No Pattern Found</h6>
                                <ul>
                                    <li>â†’ Status: NO_PATTERN</li>
                                    <li>â†’ User must create manual mapping</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <!-- Step 4 -->
                <div class="flow-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Find Matching Source Columns (Vector Search)</h4>
                        <p>Use Vector Search to find user's source columns that are semantically similar to the pattern's descriptions</p>
                        <div class="step-visual">
<strong>Build Search Query:</strong>
search_query = target_description + pattern_source_descriptions

"First address line of mailing address of member.
 ADR_LINE_1: First line of mailing address | SAK_RECIP: Recipient ID..."

<strong>Vector Search on unmapped_fields:</strong>

vector_search(
  index = "unmapped_fields_vs_index",
  query = search_query,
  filters = { project_id: 123 },
  num_results = 5
)

<strong>Results (Semantic Matches):</strong>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ src_table            â”‚ src_column       â”‚ src_comments                                â”‚ score â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ACME_RECIPIENT       â”‚ STREET_ADDR_1    â”‚ Primary street address line for recipient  â”‚ 0.89  â”‚
â”‚ ACME_ADDR_HISTORY    â”‚ ADDR_LINE_1      â”‚ First line of historical address record    â”‚ 0.85  â”‚
â”‚ ACME_RECIPIENT       â”‚ RECIP_KEY        â”‚ Primary identifier for the recipient       â”‚ 0.72  â”‚
â”‚ ACME_RECIPIENT       â”‚ COUNTY_CD        â”‚ County FIPS code for recipient address     â”‚ 0.65  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
                        </div>
                        
                        <div class="decision-box">
                            <div class="decision-option yes">
                                <h6>âœ… Matching Sources Found</h6>
                                <ul>
                                    <li>â†’ Continue to Step 5 (LLM Rewrite)</li>
                                    <li>â†’ Pass matched sources to LLM</li>
                                </ul>
                            </div>
                            <div class="decision-option no">
                                <h6>âŒ No Matching Sources</h6>
                                <ul>
                                    <li>â†’ Status: NO_MATCH</li>
                                    <li>â†’ Pattern exists but user has no similar sources</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <!-- Step 5 -->
                <div class="flow-step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h4>LLM Rewrites SQL with User's Sources</h4>
                        <p>Send the pattern SQL and matched source columns to the LLM for intelligent rewriting</p>
                        
                        <div class="llm-prompt">
                            <h5>ğŸ“¤ LLM Prompt</h5>
                            <pre>You are rewriting a SQL mapping template by replacing source columns with the user's columns.

TARGET COLUMN: ADDR_1_TXT

ORIGINAL SQL TEMPLATE:
```sql
SELECT DISTINCT TRIM(INITCAP(b.ADR_LINE_1)) as ADDR_1_TXT 
FROM oz_dev.bronze_dmes_de.t_re_base b 
JOIN oz_dev.silver_dmes_de.mbr_fndtn mf ON b.SAK_RECIP = mf.SRC_KEY_ID...
```

ORIGINAL COLUMN DESCRIPTIONS FROM PATTERN:
ADR_LINE_1: First line of mailing address | SAK_RECIP: Recipient ID

USER'S MATCHING SOURCE COLUMNS:
- ACME_RECIPIENT.STREET_ADDR_1
  Description: Primary street address line for the recipient
  Type: STRING
- ACME_RECIPIENT.RECIP_KEY
  Description: Primary identifier for the recipient
  Type: BIGINT

SILVER TABLES (CONSTANT - DO NOT MODIFY):
- oz_dev.silver_dmes_de.mbr_fndtn AS mf (DO NOT CHANGE)

RULES:
1. Silver tables stay EXACTLY as-is
2. Replace bronze table names with user's source tables
3. Replace bronze column names with user's source columns
4. Keep all JOINs, WHERE clauses, UNION structure intact
5. Keep all transformations (TRIM, INITCAP, etc.)

Return JSON: { rewritten_sql, changes, warnings, confidence, reasoning }</pre>
                        </div>
                        
                        <div class="llm-prompt" style="border-color: var(--primary);">
                            <h5 style="color: var(--primary);">ğŸ“¥ LLM Response</h5>
                            <pre>{
  "rewritten_sql": "SELECT DISTINCT TRIM(INITCAP(b.STREET_ADDR_1)) as ADDR_1_TXT 
                    FROM ACME_RECIPIENT b 
                    JOIN oz_dev.silver_dmes_de.mbr_fndtn mf ON b.RECIP_KEY = mf.SRC_KEY_ID...",
  "changes": [
    {"type": "table_replace", "original": "t_re_base", "new": "ACME_RECIPIENT"},
    {"type": "column_replace", "original": "ADR_LINE_1", "new": "STREET_ADDR_1"},
    {"type": "column_replace", "original": "SAK_RECIP", "new": "RECIP_KEY"}
  ],
  "warnings": [],
  "confidence": 0.85,
  "reasoning": "Replaced bronze tables and columns based on semantic matching. 
                Silver tables preserved unchanged."
}</pre>
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <!-- Step 6 -->
                <div class="flow-step">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <h4>Store Suggestion for Review</h4>
                        <p>Save the AI-generated suggestion to <code>mapping_suggestions</code> table</p>
                        <div class="step-visual">
<strong>INSERT INTO mapping_suggestions:</strong>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column                  â”‚ Value                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ project_id              â”‚ 123                                                         â”‚
â”‚ tgt_column              â”‚ ADDR_1_TXT                                                  â”‚
â”‚ pattern_sql             â”‚ (Original pattern SQL)                                      â”‚
â”‚ matched_source_fields   â”‚ [{"src_table": "ACME_RECIPIENT", "src_column": "STREET..."} â”‚
â”‚ suggested_sql           â”‚ SELECT DISTINCT TRIM(INITCAP(b.STREET_ADDR_1))...          â”‚
â”‚ sql_changes             â”‚ [{"type": "column_replace", "original": "ADR...", "new":...â”‚
â”‚ confidence_score        â”‚ 0.85                                                        â”‚
â”‚ warnings                â”‚ []                                                          â”‚
â”‚ suggestion_status       â”‚ PENDING                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <!-- Stage 3 -->
                <div class="stage-box">
                    <h5>â•â•â• STAGE 3: USER REVIEW â•â•â•</h5>
                    <p style="color: var(--text-secondary);">User reviews AI suggestions and approves, edits, or rejects</p>
                </div>
                
                <!-- Step 7 -->
                <div class="flow-step">
                    <div class="step-number">7</div>
                    <div class="step-content">
                        <h4>User Reviews Suggestion</h4>
                        <p>UI shows the suggested SQL with highlighted changes, warnings, and confidence score</p>
                        <div class="step-visual">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ ADDR_1_TXT                                            Confidence: 85%        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ <strong>AI Changes:</strong>                                                                 â”‚
â”‚  [table_replace: t_re_base â†’ ACME_RECIPIENT]                                    â”‚
â”‚  [column_replace: ADR_LINE_1 â†’ STREET_ADDR_1]                                   â”‚
â”‚  [column_replace: SAK_RECIP â†’ RECIP_KEY]                                        â”‚
â”‚                                                                                 â”‚
â”‚ <strong>Suggested SQL:</strong>                                                              â”‚
â”‚  SELECT DISTINCT TRIM(INITCAP(b.STREET_ADDR_1)) as ADDR_1_TXT                  â”‚
â”‚  FROM ACME_RECIPIENT b                                                          â”‚
â”‚  JOIN oz_dev.silver_dmes_de.mbr_fndtn mf ON b.RECIP_KEY = mf.SRC_KEY_ID        â”‚
â”‚  ...                                                                            â”‚
â”‚                                                                                 â”‚
â”‚  [âœ“ Approve]  [âœï¸ Edit]  [âœ— Reject]  [â­ï¸ Skip]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </div>
                        
                        <div class="decision-box">
                            <div class="decision-option yes">
                                <h6>âœ… Approve / Edit & Approve</h6>
                                <ul>
                                    <li>â†’ Create record in mapped_fields</li>
                                    <li>â†’ Link to project_id</li>
                                    <li>â†’ Available for future pattern matching</li>
                                </ul>
                            </div>
                            <div class="decision-option no">
                                <h6>âŒ Reject</h6>
                                <ul>
                                    <li>â†’ Save feedback with reason</li>
                                    <li>â†’ AI learns to avoid this suggestion</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </section>
        
        <!-- Key Tables -->
        <section class="section">
            <h2 class="section-title">V4 Data Model</h2>
            
            <!-- semantic_fields -->
            <div class="table-container">
                <h4>ğŸ¯ semantic_fields <span class="badge">TARGET DEFINITIONS</span></h4>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    The "gold standard" target columns that need to be mapped. Pre-loaded for all domains.
                </p>
                <table>
                    <thead><tr><th>Column</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td><code>semantic_field_id</code></td><td>Primary key</td></tr>
                        <tr><td><code>domain</code></td><td>Domain category (Member, Claims, etc.)</td></tr>
                        <tr><td><code>tgt_table_physical_name</code></td><td>Target table name (e.g., MBR_CNTCT)</td></tr>
                        <tr><td><code>tgt_column_physical_name</code></td><td>Target column name (e.g., ADDR_1_TXT)</td></tr>
                        <tr><td><code>tgt_comments</code></td><td><strong>Critical for AI</strong> - Column description</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- unmapped_fields -->
            <div class="table-container">
                <h4>ğŸ“¥ unmapped_fields <span class="badge vector">VECTOR INDEXED</span></h4>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    User's uploaded source columns. Vector-indexed for semantic search.
                </p>
                <table>
                    <thead><tr><th>Column</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td><code>unmapped_field_id</code></td><td>Primary key</td></tr>
                        <tr><td><code>project_id</code></td><td>FK to mapping_projects</td></tr>
                        <tr><td><code>src_table_physical_name</code></td><td>Source table (e.g., ACME_RECIPIENT)</td></tr>
                        <tr><td><code>src_column_physical_name</code></td><td>Source column (e.g., STREET_ADDR_1)</td></tr>
                        <tr><td><code>src_comments</code></td><td><strong>Critical for AI</strong> - Used for vector matching</td></tr>
                        <tr><td><code>mapping_status</code></td><td>PENDING, MAPPED, UNMAPPED</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- mapped_fields -->
            <div class="table-container" style="border: 2px solid var(--primary);">
                <h4>âœ… mapped_fields <span class="badge key">PATTERNS</span> <span class="badge vector">VECTOR INDEXED</span></h4>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>Approved mappings that serve as patterns.</strong> Global patterns have <code>project_id = NULL</code>.
                </p>
                <table>
                    <thead><tr><th>Column</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td><code>mapped_field_id</code></td><td>Primary key</td></tr>
                        <tr><td><code>project_id</code></td><td>NULL = global pattern, else project-specific</td></tr>
                        <tr><td><code>semantic_field_id</code></td><td>FK to target column</td></tr>
                        <tr style="background: rgba(16, 185, 129, 0.1);"><td><code>source_expression</code></td><td><strong>The complete SQL expression</strong></td></tr>
                        <tr style="background: rgba(16, 185, 129, 0.1);"><td><code>source_descriptions</code></td><td>Original source column descriptions (for matching)</td></tr>
                        <tr style="background: rgba(16, 185, 129, 0.1);"><td><code>join_metadata</code></td><td>JSON with silver tables, union branches, etc.</td></tr>
                        <tr><td><code>is_approved_pattern</code></td><td>TRUE = available for AI to use as pattern</td></tr>
                        <tr><td><code>source_relationship_type</code></td><td>SINGLE, JOIN, UNION, UNION_JOIN</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- mapping_suggestions -->
            <div class="table-container" style="border: 2px solid var(--secondary);">
                <h4>ğŸ’¡ mapping_suggestions <span class="badge new">V4 NEW</span></h4>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    AI-generated suggestions awaiting user review.
                </p>
                <table>
                    <thead><tr><th>Column</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td><code>suggestion_id</code></td><td>Primary key</td></tr>
                        <tr><td><code>project_id</code></td><td>FK to mapping_projects</td></tr>
                        <tr><td><code>target_table_status_id</code></td><td>FK to target table being processed</td></tr>
                        <tr><td><code>semantic_field_id</code></td><td>FK to target column</td></tr>
                        <tr><td><code>pattern_mapped_field_id</code></td><td>FK to the pattern used</td></tr>
                        <tr><td><code>pattern_sql</code></td><td>Original pattern SQL</td></tr>
                        <tr><td><code>matched_source_fields</code></td><td>JSON array of matched user sources</td></tr>
                        <tr style="background: rgba(99, 102, 241, 0.1);"><td><code>suggested_sql</code></td><td><strong>LLM-rewritten SQL with user's columns</strong></td></tr>
                        <tr style="background: rgba(99, 102, 241, 0.1);"><td><code>sql_changes</code></td><td>JSON array of changes made by LLM</td></tr>
                        <tr><td><code>confidence_score</code></td><td>0.0 - 1.0</td></tr>
                        <tr><td><code>warnings</code></td><td>Any issues found by LLM</td></tr>
                        <tr><td><code>suggestion_status</code></td><td>PENDING, APPROVED, REJECTED, NO_PATTERN, NO_MATCH</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- SQL for Testing -->
        <section class="section">
            <h2 class="section-title">SQL for Testing LLM</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Use this SQL in Databricks to test the LLM prompt directly:
            </p>
            
            <div class="step-visual">
<pre>SELECT ai_query(
  'databricks-meta-llama-3-3-70b-instruct',
  'You are rewriting a SQL mapping template by replacing source columns...

TARGET COLUMN: ADDR_1_TXT

ORIGINAL SQL TEMPLATE:
SELECT DISTINCT TRIM(INITCAP(b.ADR_LINE_1)) as ADDR_1_TXT 
FROM oz_dev.bronze_dmes_de.t_re_base b...

USER''S MATCHING SOURCE COLUMNS:
- ACME_RECIPIENT.STREET_ADDR_1
  Description: Primary street address line

Return JSON: { rewritten_sql, changes, warnings, confidence, reasoning }'
) as llm_response;</pre>
            </div>
        </section>
        
        <!-- Benefits -->
        <section class="section">
            <h2 class="section-title">Why Target-First?</h2>
            <div class="benefits-grid">
                <div class="benefit">
                    <div class="benefit-icon">ğŸ¯</div>
                    <h4>Complete Coverage</h4>
                    <p>Every target column is addressed - no gaps from users missing sources</p>
                </div>
                <div class="benefit">
                    <div class="benefit-icon">ğŸ“š</div>
                    <h4>Pattern Reuse</h4>
                    <p>One approved mapping becomes a template for all future projects</p>
                </div>
                <div class="benefit">
                    <div class="benefit-icon">ğŸ”„</div>
                    <h4>SQL Preservation</h4>
                    <p>Complex JOINs, UNIONs, transformations preserved from patterns</p>
                </div>
                <div class="benefit">
                    <div class="benefit-icon">ğŸ§ </div>
                    <h4>Semantic Matching</h4>
                    <p>Vector search finds matches even when column names differ completely</p>
                </div>
                <div class="benefit">
                    <div class="benefit-icon">âœï¸</div>
                    <h4>User Control</h4>
                    <p>Review, edit, or reject any AI suggestion before approval</p>
                </div>
                <div class="benefit">
                    <div class="benefit-icon">ğŸ“Š</div>
                    <h4>Progress Tracking</h4>
                    <p>Dashboard shows patterns found, matches pending, approved counts</p>
                </div>
            </div>
        </section>
        
        <!-- Technology Stack -->
        <section class="section">
            <h2 class="section-title">Technology Stack</h2>
            <div class="benefits-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="benefit" style="text-align: center;">
                    <div class="benefit-icon">ğŸ”</div>
                    <h4>Vector Search</h4>
                    <p>Databricks Vector Search Index on unmapped_fields</p>
                </div>
                <div class="benefit" style="text-align: center;">
                    <div class="benefit-icon">ğŸ¤–</div>
                    <h4>LLM</h4>
                    <p>Databricks Foundation Model (Llama 3.3 70B)</p>
                </div>
                <div class="benefit" style="text-align: center;">
                    <div class="benefit-icon">ğŸ’¾</div>
                    <h4>Database</h4>
                    <p>Delta Lake Tables</p>
                </div>
                <div class="benefit" style="text-align: center;">
                    <div class="benefit-icon">âš™ï¸</div>
                    <h4>Backend</h4>
                    <p>FastAPI (Python)</p>
                </div>
                <div class="benefit" style="text-align: center;">
                    <div class="benefit-icon">ğŸ–¥ï¸</div>
                    <h4>Frontend</h4>
                    <p>Vue 3 + PrimeVue</p>
                </div>
            </div>
        </section>
        
        <footer>
            <p>Smart Mapper V4 - Target-First AI Mapping Architecture</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Powered by Databricks AI</p>
        </footer>
    </div>
</body>
</html>
